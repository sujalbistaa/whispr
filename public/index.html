<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whispr - Anonymous Confessions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2'><path d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'/></svg>">
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
    <div x-data="whispr()" x-init="init()" class="max-w-2xl mx-auto p-4">
        <header class="mb-8 mt-6">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-semibold tracking-tight">Whispr</h1>
                <div class="flex gap-2 bg-zinc-900 rounded-lg p-1">
                    <button 
                        @click="switchMode('latest')" 
                        :class="mode === 'latest' ? 'bg-zinc-800 text-zinc-100' : 'text-zinc-400 hover:text-zinc-200'"
                        class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
                    >
                        Latest
                    </button>
                    <button 
                        @click="switchMode('trending')" 
                        :class="mode === 'trending' ? 'bg-zinc-800 text-zinc-100' : 'text-zinc-400 hover:text-zinc-200'"
                        class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
                    >
                        Trending
                    </button>
                </div>
            </div>
        </header>

        <div class="bg-zinc-900 rounded-lg p-6 mb-6 border border-zinc-800">
            <form @submit.prevent="submitPost()">
                <textarea 
                    x-model="content"
                    @input="updateCharCount()"
                    placeholder="Share something anonymously..."
                    maxlength="1000"
                    rows="4"
                    class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-3 text-zinc-100 placeholder-zinc-500 focus:outline-none focus:border-zinc-700 focus:ring-1 focus:ring-zinc-700 resize-none"
                ></textarea>
                <div class="flex items-center justify-between mt-3">
                    <span class="text-sm text-zinc-500" x-text="charCount + ' / 1000'"></span>
                    <button 
                        type="submit"
                        :disabled="posting || content.trim().length === 0"
                        :class="posting || content.trim().length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-indigo-700'"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors"
                    >
                        <span x-show="!posting">Post</span>
                        <span x-show="posting">Posting...</span>
                    </button>
                </div>
            </form>
        </div>

        <div x-show="loading" class="text-center py-12">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-zinc-700 border-t-zinc-400"></div>
        </div>

        <div x-show="!loading" class="space-y-4">
            <template x-for="post in posts" :key="post.id">
                <div 
                    x-show="post.visible !== false"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 translate-y-4"
                    x-transition:enter-end="opacity-100 translate-y-0"
                    class="bg-zinc-900 rounded-lg p-6 border border-zinc-800"
                >
                    <p class="text-zinc-100 whitespace-pre-wrap leading-relaxed mb-4" x-text="post.content"></p>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2 bg-zinc-950 rounded-lg px-3 py-1.5 border border-zinc-800">
                            <button 
                                @click="vote(post.id, 1)"
                                class="text-zinc-400 hover:text-indigo-400 transition-colors p-1"
                                title="Upvote"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                </svg>
                            </button>
                            <span class="text-sm font-medium text-zinc-300 min-w-[2rem] text-center" x-text="post.score"></span>
                            <button 
                                @click="vote(post.id, -1)"
                                class="text-zinc-400 hover:text-red-400 transition-colors p-1"
                                title="Downvote"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                        <span class="text-xs text-zinc-500" x-text="formatTime(post.createdAt)"></span>
                    </div>
                </div>
            </template>

            <div x-show="posts.length === 0 && !loading" class="text-center py-12 text-zinc-500">
                <p>No posts yet. Be the first to share something!</p>
            </div>
        </div>
    </div>

    <script>
        function whispr() {
            return {
                posts: [],
                content: '',
                charCount: 0,
                mode: 'latest',
                loading: true,
                posting: false,
                ws: null,
                reconnectAttempts: 0,
                maxReconnectAttempts: 10,

                init() {
                    this.fetchPosts();
                    this.connectWS();
                },

                updateCharCount() {
                    this.charCount = this.content.length;
                },

                async fetchPosts() {
                    this.loading = true;
                    try {
                        const endpoint = this.mode === 'latest' ? '/api/posts' : '/api/trending';
                        const response = await fetch(endpoint);
                        if (response.ok) {
                            const data = await response.json();
                            this.posts = data || [];
                        }
                    } catch (error) {
                        console.error('Error fetching posts:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async submitPost() {
                    if (this.content.trim().length === 0 || this.posting) return;

                    this.posting = true;
                    try {
                        const response = await fetch('/api/posts', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ content: this.content.trim() })
                        });

                        if (response.ok) {
                            this.content = '';
                            this.charCount = 0;
                        } else {
                            console.error('Failed to post');
                        }
                    } catch (error) {
                        console.error('Error posting:', error);
                    } finally {
                        this.posting = false;
                    }
                },

                async vote(postId, value) {
                    try {
                        const response = await fetch(`/api/posts/${postId}/vote`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ value })
                        });

                        if (!response.ok) {
                            console.error('Failed to vote');
                        }
                    } catch (error) {
                        console.error('Error voting:', error);
                    }
                },

                switchMode(newMode) {
                    if (this.mode !== newMode) {
                        this.mode = newMode;
                        this.fetchPosts();
                    }
                },

                connectWS() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;

                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        this.reconnectAttempts = 0;
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleWSMessage(message);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                    this.ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        this.reconnect();
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },

                handleWSMessage(message) {
                    switch (message.type) {
                        case 'new_post':
                            // FIX: Check `message.data` (which we send from Go)
                            if (this.mode === 'latest' && message.data) {
                                this.posts.unshift(message.data);
                            }
                            break;
                        case 'vote':
                            // FIX: Check `message.data`
                            if (message.data) {
                                // The payload is {id, score}
                                const post = this.posts.find(p => p.id === message.data.id);
                                if (post) {
                                    post.score = message.data.score;
                                }
                            }
                            break;
                        case 'delete':
                            // FIX: Check `message.data`
                            if (message.data) {
                                // The payload is {id}
                                const index = this.posts.findIndex(p => p.id === message.data.id);
                                if (index !== -1) {
                                    // Set a flag for the transition to work
                                    this.posts[index].visible = false;
                                    // Remove from array after transition
                                    setTimeout(() => {
                                        this.posts.splice(index, 1);
                                    }, 200);
                                }
                            }
                            break;
                    }
                },

                reconnect() {
                    if (this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
                        console.log(`Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`);
                        setTimeout(() => this.connectWS(), delay);
                    }
                },

                formatTime(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = now - date;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);

                    if (minutes < 1) return 'just now';
                    if (minutes < 60) return `${minutes}m ago`;
                    if (hours < 24) return `${hours}h ago`;
                    if (days < 7) return `${days}d ago`;
                    return date.toLocaleDateString();
                }
            }
        }
    </script>
</body>
</html>